!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("typescript-collections"),require("sanctuary-type-classes")):"function"==typeof define&&define.amd?define(["exports","typescript-collections","sanctuary-type-classes"],n):n(t.Sodium={},t.Collections,t.Z)}(this,function(t,e,r){"use strict";var o=function(){function e(t,n){this.rank=t,this.action=n,this.seq=e.nextSeq++}return e.prototype.toString=function(){return this.seq.toString()},e.nextSeq=0,e}(),a=function(){function i(){this.inCallback=0,this.toRegen=!1,this.prioritizedQ=new e.PriorityQueue(function(t,n){return t.rank.rank<n.rank.rank?1:t.rank.rank>n.rank.rank?-1:t.seq<n.seq?1:t.seq>n.seq?-1:0}),this.entries=new e.Set(function(t){return t.toString()}),this.sampleQ=[],this.lastQ=[],this.postQ=null}return i.prototype.requestRegen=function(){this.toRegen=!0},i.prototype.prioritized=function(t,n){var e=new o(t,n);this.prioritizedQ.enqueue(e),this.entries.add(e)},i.prototype.sample=function(t){this.sampleQ.push(t)},i.prototype.last=function(t){this.lastQ.push(t)},i.post_=function(t){i.run(function(){return i.currentTransaction.post(0,t)})},i.prototype.post=function(t,n){for(null==this.postQ&&(this.postQ=[]);this.postQ.length<=t;)this.postQ.push(null);var e=this.postQ[t],r=null===e?n:function(){e(),n()};this.postQ[t]=r},i.prototype.checkRegen=function(){if(this.toRegen){this.toRegen=!1,this.prioritizedQ.clear();for(var t=this.entries.toArray(),n=0;n<t.length;n++)this.prioritizedQ.enqueue(t[n])}},i.prototype.isActive=function(){return!!i.currentTransaction},i.prototype.close=function(){for(;;){for(;this.checkRegen(),!this.prioritizedQ.isEmpty();){var t=this.prioritizedQ.dequeue();this.entries.remove(t),t.action()}var n=this.sampleQ;this.sampleQ=[];for(var e=0;e<n.length;e++)n[e]();if(this.prioritizedQ.isEmpty()&&this.sampleQ.length<1)break}for(e=0;e<this.lastQ.length;e++)this.lastQ[e]();if(this.lastQ=[],null!=this.postQ){for(e=0;e<this.postQ.length;e++)if(null!=this.postQ[e]){var r=i.currentTransaction;try{if(0<e){i.currentTransaction=new i;try{this.postQ[e](),i.currentTransaction.close()}catch(t){throw i.currentTransaction.close(),t}}else i.currentTransaction=null,this.postQ[e]();i.currentTransaction=r}catch(t){throw i.currentTransaction=r,t}}this.postQ=null}},i.onStart=function(t){i.onStartHooks.push(t)},i.run=function(t){var n=i.currentTransaction;if(null===n){if(!i.runningOnStartHooks){i.runningOnStartHooks=!0;try{for(var e=0;e<i.onStartHooks.length;e++)i.onStartHooks[e]()}finally{i.runningOnStartHooks=!1}}i.currentTransaction=new i}try{var r=t();return null===n&&(i.currentTransaction.close(),i.currentTransaction=null),r}catch(t){throw null===n&&(i.currentTransaction.close(),i.currentTransaction=null),t}},i.currentTransaction=null,i.onStartHooks=[],i.runningOnStartHooks=!1,i}(),i=0;var u,n,l=function(){function t(t,n){if(this.registered=!1,(this.deregister_=null)===t)throw new Error("null origin!");this.origin=t,this.register_=n}return t.prototype.register=function(t){var n=this;this.registered||(this.registered=!0,null!==this.register_?this.deregister_=this.register_():(this.origin.increment(t),this.deregister_=function(){return n.origin.decrement(t)}))},t.prototype.deregister=function(t){this.registered&&(this.registered=!1,null!==this.deregister_&&this.deregister_())},t}();(n=u||(u={}))[n.black=0]="black",n[n.gray=1]="gray",n[n.white=2]="white",n[n.purple=3]="purple";var s=[],c=0,f=function(){function n(t,n,e){this.targets=[],this.childrn=[],this.visited=!1,this.color=u.black,this.buffered=!1,this.refCountAdj=0,this.name=t,this.rank=n,this.sources=e,this.id=c++}return n.prototype.refCount=function(){return this.targets.length},n.prototype.register=function(t){return this.increment(t)},n.prototype.deregister=function(t){this.decrement(t),a.post_(function(){return a.post_(function(){return n.collectCycles()})})},n.prototype.incRefCount=function(t){var n=!1;if(0==this.refCount())for(var e=0;e<this.sources.length;e++)this.sources[e].register(this);return this.targets.push(t),t.childrn.push(this),t.ensureBiggerThan(this.rank)&&(n=!0),i++,n},n.prototype.decRefCount=function(t){for(var n=!1,e=t.childrn.length-1;0<=e;e--)t.childrn[e]===this&&t.childrn.splice(e,1);for(e=0;e<this.targets.length;e++)if(this.targets[e]===t){this.targets.splice(e,1),n=!0;break}if(n){if(0==this.refCount())for(e=0;e<this.sources.length;e++)this.sources[e].deregister(this);i--}},n.prototype.addSource=function(t){this.sources.push(t),0<this.refCount()&&t.register(this)},n.prototype.ensureBiggerThan=function(t){if(this.rank>t||this.visited)return!1;this.visited=!0,this.rank=t+1;for(var n=0;n<this.targets.length;n++)this.targets[n].ensureBiggerThan(this.rank);return!(this.visited=!1)},n.prototype.descr=function(){var t=null;switch(this.color){case u.black:t="black";break;case u.gray:t="gray";break;case u.white:t="white";break;case u.purple:t="purple"}for(var n=this.id+" "+this.name+" ["+this.refCount()+"/"+this.refCountAdj+"] "+t+" ->",e=this.children(),r=0;r<e.length;r++)n=n+" "+e[r].id;return n},n.prototype.children=function(){return this.childrn},n.prototype.increment=function(t){return this.incRefCount(t)},n.prototype.decrement=function(t){this.decRefCount(t),0==this.refCount()?this.release():this.possibleRoots()},n.prototype.release=function(){this.color=u.black,this.buffered||this.free()},n.prototype.free=function(){for(;0<this.targets.length;)this.decRefCount(this.targets[0])},n.prototype.possibleRoots=function(){this.color!=u.purple&&(this.color=u.purple,this.buffered||(this.buffered=!0,s.push(this)))},n.collectCycles=function(){if(!n.collectingCycles)try{n.collectingCycles=!0,n.markRoots(),n.scanRoots(),n.collectRoots()}finally{n.collectingCycles=!1}},n.markRoots=function(){for(var t=[],n=0;n<s.length;n++)s[n].color==u.purple?(s[n].markGray(),t.push(s[n])):(s[n].buffered=!1,s[n].color==u.black&&0==s[n].refCount()&&s[n].free());s=t},n.scanRoots=function(){for(var t=0;t<s.length;t++)s[t].scan()},n.collectRoots=function(){for(var t=0;t<s.length;t++)s[t].buffered=!1,s[t].collectWhite();s=[]},n.prototype.markGray=function(){if(this.color!=u.gray){this.color=u.gray;for(var t=this.children(),n=0;n<t.length;n++)t[n].refCountAdj--,t[n].markGray()}},n.prototype.scan=function(){if(this.color==u.gray)if(0<this.refCount()+this.refCountAdj)this.scanBlack();else{this.color=u.white;for(var t=this.children(),n=0;n<t.length;n++)t[n].scan()}},n.prototype.scanBlack=function(){this.color=u.black;for(var t=this.children(),n=0;n<t.length;n++)t[n].refCountAdj++,t[n].color!=u.black&&t[n].scanBlack()},n.prototype.collectWhite=function(){if(this.color==u.white&&!this.buffered){0,this.color=u.black,this.refCountAdj=0;for(var t=this.children(),n=0;n<t.length;n++)t[n].collectWhite();this.free()}},n.NULL=new n("user",1e12,[]),n.collectingCycles=!1,n}(),p=function(t,n){this.f=t,this.deps=n};function h(t){return t instanceof p?t.deps:[]}function _(t){return t instanceof p?t.f:t}var v=function(t,n){this.f=t,this.deps=n};function y(t){return t instanceof v?t.deps:[]}function d(t){return t instanceof v?t.f:t}var g=function(t,n){this.f=t,this.deps=n};function m(t){return t instanceof g?t.deps:[]}function w(t){return t instanceof g?t.f:t}var x=function(t,n){this.f=t,this.deps=n};function T(t){return t instanceof x?t.deps:[]}function V(t){return t instanceof x?t.f:t}var k=function(t,n){this.f=t,this.deps=n};function b(t){return t instanceof k?t.deps:[]}function S(t){return t instanceof k?t.f:t}var C=function(t,n){this.f=t,this.deps=n};function N(t){return t instanceof C?t.deps:[]}function z(t){return t instanceof C?t.f:t}function Q(t){for(var n=[],e=0;e<t.length;e++){var r=t[e];n.push(new l(r.getVertex__(),null))}return n}var L=function(t,n){return(L=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])})(t,n)};function R(t,n){function e(){this.constructor=t}L(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}var q=function(){function t(t,n){this.f=d(t),this.out=n,this.out.getVertex__().sources=this.out.getVertex__().sources.concat(Q(y(t))),this.accumValid=!1}return t.prototype.send_=function(t){var n=this;this.accumValid?this.accum=this.f(this.accum,t):(a.currentTransaction.prioritized(this.out.getVertex__(),function(){n.out.send_(n.accum),n.accumValid=!1,n.accum=null}),this.accum=t,this.accumValid=!0)},t}(),A=function(){function o(t){this.f=t}return o.prototype.get=function(){return this.f()},o.prototype.map=function(t){var n=this;return new o(function(){return t(n.f())})},o.prototype.lift=function(t,n){var e=this;return new o(function(){return n(e.f(),t.f())})},o.prototype.lift3=function(t,n,e){var r=this;return new o(function(){return e(r.f(),t.f(),n.f())})},o.prototype.lift4=function(t,n,e,r){var i=this;return new o(function(){return r(i.f(),t.f(),n.f(),e.f())})},o}(),U=function(){function t(){}return t.UNIT=new t,t}(),E=function(){function r(){}return r.updates=function(t){return t.getStream__()},r.value=function(e){return a.run(function(){var t=new P;a.currentTransaction.prioritized(t.getVertex__(),function(){t.send_(U.UNIT)});var n=t.snapshot1(e);return r.updates(e).orElse(n)})},r.defer=function(t){return r.split(t.map(function(t){return[t]}))},r.split=function(t){var r=new P(null);return r.setVertex__(new f("split",0,[new l(t.getVertex__(),function(){return t.listen_(r.getVertex__(),function(n){for(var t=function(t){a.currentTransaction.post(t,function(){a.run(function(){r.send_(n[t])})})},e=0;e<n.length;e++)t(e)},!1)})])),r},r}(),M=function(t){this.hasValue=!1,this.value=null,this.cell=t},O=function(){this.f=null,this.f_present=!1,this.a=null,this.a_present=!1},j=function(){function c(t,n){var e=this;this.value=t,n?a.run(function(){return e.setStream(n)}):(this.str=new B,this.vertex=new f("ConstCell",0,[]))}return c.prototype.setStream=function(t){var n=this;this.str=t;var e=this,r=new l(t.getVertex__(),function(){return t.listen_(e.vertex,function(t){null==e.valueUpdate&&a.currentTransaction.last(function(){e.value=e.valueUpdate,e.lazyInitValue=null,e.valueUpdate=null}),e.valueUpdate=t},!1)});this.vertex=new f("Cell",0,[r]),this.vertex.register(f.NULL),a.currentTransaction.last(function(){n.vertex.deregister(f.NULL)})},c.prototype.getVertex__=function(){return this.vertex},c.prototype.getStream__=function(){return this.str},c.prototype.sample=function(){var t=this;return a.run(function(){return t.sampleNoTrans__()})},c.prototype.sampleNoTrans__=function(){return this.value},c.prototype.sampleLazy=function(){var t=this;return a.run(function(){return t.sampleLazyNoTrans__()})},c.prototype.sampleLazyNoTrans__=function(){var t=this,n=new M(t);return a.currentTransaction.sample(function(){n.value=null!=t.valueUpdate?t.valueUpdate:t.sampleNoTrans__(),n.hasValue=!0,n.cell=null}),new A(function(){return n.hasValue?n.value:n.cell.sample()})},c.prototype.map=function(t){var n=this;return a.run(function(){return E.updates(n).map(t).holdLazy(n.sampleLazy().map(_(t)))})},c.prototype.lift=function(t,n){var e=d(n),r=this.map(function(n){return function(t){return e(n,t)}});return c.apply(r,t,Q(y(n)))},c.prototype.lift3=function(t,n,e){var r=w(e),i=this.map(function(e){return function(n){return function(t){return r(e,n,t)}}});return c.apply(c.apply(i,t),n,Q(m(e)))},c.prototype.lift4=function(t,n,e,r){var i=V(r),o=this.map(function(r){return function(e){return function(n){return function(t){return i(r,e,n,t)}}}});return c.apply(c.apply(c.apply(o,t),n),e,Q(T(r)))},c.prototype.lift5=function(t,n,e,r,i){var o=S(i),u=this.map(function(i){return function(r){return function(e){return function(n){return function(t){return o(i,r,e,n,t)}}}}});return c.apply(c.apply(c.apply(c.apply(u,t),n),e),r,Q(b(i)))},c.prototype.lift6=function(t,n,e,r,i,o){var u=z(o),s=this.map(function(o){return function(i){return function(r){return function(e){return function(n){return function(t){return u(o,i,r,e,n,t)}}}}}});return c.apply(c.apply(c.apply(c.apply(c.apply(s,t),n),e),r),i,Q(N(o)))},c.apply=function(u,s,c){return a.run(function(){var n=new O,e=new P,t=E.value(u),r=E.value(s),i=new l(t.getVertex__(),function(){return t.listen_(e.getVertex__(),function(t){n.f=t,n.f_present=!0,n.a_present&&e.send_(n.f(n.a))},!1)}),o=new l(r.getVertex__(),function(){return r.listen_(e.getVertex__(),function(t){n.a=t,n.a_present=!0,n.f_present&&e.send_(n.f(n.a))},!1)});return e.setVertex__(new f("apply",0,[i,o].concat(c||[]))),e.coalesce__(function(t,n){return n}).holdLazy(new A(function(){return u.sampleNoTrans__()(s.sampleNoTrans__())}))})},c.switchC=function(o){return a.run(function(){var t=o.sampleLazy().map(function(t){return t.sample()}),e=new P,r=null,i=E.value(o),n=new l(i.getVertex__(),function(){var n=null===r?null:E.value(r).listen_(e.getVertex__(),function(t){return e.send_(t)},!1),t=i.listen_(e.getVertex__(),function(t){r=t,null!==n&&n(),n=E.value(t).listen_(e.getVertex__(),function(t){return e.send_(t)},!1)},!1);return function(){t(),n()}});return e.setVertex__(new f("switchC",0,[n])),e.coalesce__(function(t,n){return n}).holdLazy(t)})},c.switchS=function(i){return a.run(function(){var e=new P,r=function(t){e.send_(t)},t=new l(i.getVertex__(),function(){var n=i.sampleNoTrans__().listen_(e.getVertex__(),r,!1),t=i.getStream__().listen_(e.getVertex__(),function(t){n(),n=t.listen_(e.getVertex__(),r,!0)},!1);return function(){t(),n()}});return e.setVertex__(new f("switchS",0,[t])),e})},c.prototype.listen=function(t){var n=this;return a.run(function(){return E.value(n).listen(t)})},c["fantasy-land/of"]=function(t){return new c(t)},c.prototype["fantasy-land/map"]=function(t){return this.map(t)},c.prototype["fantasy-land/ap"]=function(t){return c.apply(t,this)},c}(),I=function(t,n){this.h=t,this.target=n},H=function(r){function t(t,n){var e=r.call(this,null,null)||this;return a.run(function(){n&&e.setStream(n),e.lazyInitValue=t}),e}return R(t,r),t.prototype.sampleNoTrans__=function(){return null==this.value&&null!=this.lazyInitValue&&(this.value=this.lazyInitValue.get(),this.lazyInitValue=null),this.value},t}(j),B=function(){function t(t){this.listeners=[],this.firings=[],this.vertex=t||new f("Stream",0,[])}return t.prototype.getVertex__=function(){return this.vertex},t.prototype.map=function(t){var n=this,e=new P(null),r=_(t);return e.vertex=new f("map",0,[new l(this.vertex,function(){return n.listen_(e.vertex,function(t){e.send_(r(t))},!1)})].concat(Q(h(t)))),e},t.prototype.mapTo=function(n){var t=this,e=new P(null);return e.vertex=new f("mapTo",0,[new l(this.vertex,function(){return t.listen_(e.vertex,function(t){e.send_(n)},!1)})]),e},t.prototype.orElse=function(t){return this.merge(t,function(t,n){return t})},t.prototype.merge_=function(t){var n=this,e=new P,r=new f("merge",0,[]);return r.sources.push(new l(this.vertex,function(){return n.listen_(r,function(t){e.send_(t)},!1)})),e.vertex.sources=e.vertex.sources.concat([new l(r,function(){return r.register(e.vertex),function(){r.deregister(e.vertex)}}),new l(t.vertex,function(){return t.listen_(e.vertex,function(t){e.send_(t)},!1)})]),e},t.prototype.coalesce__=function(t){var n=this,e=new P,r=new q(t,e);return e.vertex.sources=e.vertex.sources.concat([new l(this.vertex,function(){return n.listen_(e.vertex,function(t){r.send_(t)},!1)})]).concat(Q(y(t))),e},t.prototype.merge=function(t,n){var e=this;return a.run(function(){return e.merge_(t).coalesce__(n)})},t.prototype.filter=function(t){var n=this,e=new P(null),r=_(t);return e.vertex=new f("filter",0,[new l(this.vertex,function(){return n.listen_(e.vertex,function(t){r(t)&&e.send_(t)},!1)})].concat(Q(h(t)))),e},t.prototype.filterNotNull=function(){var t=this,n=new P(null);return n.vertex=new f("filterNotNull",0,[new l(this.vertex,function(){return t.listen_(n.vertex,function(t){null!==t&&n.send_(t)},!1)})]),n},t.prototype.gate=function(t){return this.snapshot(t,function(t,n){return n?t:null}).filterNotNull()},t.prototype.snapshot1=function(n){var t=this,e=new P(null);return e.vertex=new f("snapshot1",0,[new l(this.vertex,function(){return t.listen_(e.vertex,function(t){e.send_(n.sampleNoTrans__())},!1)}),new l(n.getVertex__(),null)]),e},t.prototype.snapshot=function(n,t){var e=this,r=new P(null),i=d(t);return r.vertex=new f("snapshot",0,[new l(this.vertex,function(){return e.listen_(r.vertex,function(t){r.send_(i(t,n.sampleNoTrans__()))},!1)}),new l(n.getVertex__(),null)].concat(Q(y(t)))),r},t.prototype.snapshot3=function(n,e,t){var r=this,i=new P(null),o=w(t);return i.vertex=new f("snapshot",0,[new l(this.vertex,function(){return r.listen_(i.vertex,function(t){i.send_(o(t,n.sampleNoTrans__(),e.sampleNoTrans__()))},!1)}),new l(n.getVertex__(),null),new l(e.getVertex__(),null)].concat(Q(m(t)))),i},t.prototype.snapshot4=function(n,e,r,t){var i=this,o=new P(null),u=V(t);return o.vertex=new f("snapshot",0,[new l(this.vertex,function(){return i.listen_(o.vertex,function(t){o.send_(u(t,n.sampleNoTrans__(),e.sampleNoTrans__(),r.sampleNoTrans__()))},!1)}),new l(n.getVertex__(),null),new l(e.getVertex__(),null),new l(r.getVertex__(),null)].concat(Q(T(t)))),o},t.prototype.snapshot5=function(n,e,r,i,t){var o=this,u=new P(null),s=S(t);return u.vertex=new f("snapshot",0,[new l(this.vertex,function(){return o.listen_(u.vertex,function(t){u.send_(s(t,n.sampleNoTrans__(),e.sampleNoTrans__(),r.sampleNoTrans__(),i.sampleNoTrans__()))},!1)}),new l(n.getVertex__(),null),new l(e.getVertex__(),null),new l(r.getVertex__(),null),new l(i.getVertex__(),null)].concat(Q(b(t)))),u},t.prototype.snapshot6=function(n,e,r,i,o,t){var u=this,s=new P(null),c=z(t);return s.vertex=new f("snapshot",0,[new l(this.vertex,function(){return u.listen_(s.vertex,function(t){s.send_(c(t,n.sampleNoTrans__(),e.sampleNoTrans__(),r.sampleNoTrans__(),i.sampleNoTrans__(),o.sampleNoTrans__()))},!1)}),new l(n.getVertex__(),null),new l(e.getVertex__(),null),new l(r.getVertex__(),null),new l(i.getVertex__(),null),new l(o.getVertex__(),null)].concat(Q(N(t)))),s},t.prototype.hold=function(t){return new j(t,this)},t.prototype.holdLazy=function(t){return new H(t,this)},t.prototype.collect=function(t,n){return this.collectLazy(new A(function(){return t}),n)},t.prototype.collectLazy=function(o,u){var s=this;return a.run(function(){var t=new D,n=t.holdLazy(o),e=s.snapshot(n,u),r=e.map(function(t){return t.a}),i=e.map(function(t){return t.b});return t.loop(i),r})},t.prototype.accum=function(t,n){return this.accumLazy(new A(function(){return t}),n)},t.prototype.accumLazy=function(r,i){var o=this;return a.run(function(){var t=new D,n=t.holdLazy(r),e=o.snapshot(n,i);return t.loop(e),e.holdLazy(r)})},t.prototype.once=function(){var t=this;return a.run(function(){return t.gate(t.mapTo(!1).hold(!0))})},t.prototype.listen=function(t){var n=this;return a.run(function(){return n.listen_(f.NULL,t,!1)})},t.prototype.listen_=function(e,n,t){var r=this;this.vertex.register(e)&&a.currentTransaction.requestRegen();var i=new I(n,e);if(this.listeners.push(i),!t&&0!=this.firings.length){var o=this.firings.slice();a.currentTransaction.prioritized(e,function(){for(var t=0;t<o.length;t++)n(o[t])})}return function(){for(var t=!1,n=0;n<r.listeners.length;n++)if(r.listeners[n]==i){r.listeners.splice(n,1),t=!0;break}t&&r.vertex.deregister(e)}},t.prototype["fantasy-land/map"]=function(t){return this.map(t)},t.prototype["fantasy-land/concat"]=function(t){return this.merge(t,function(t,n){return r.Semigroup.test(t)?r.concat(t,n):t})},t.prototype["fantasy-land/empty"]=function(){return new t},t}(),P=function(n){function t(t){return n.call(this,t)||this}return R(t,n),t.prototype.setVertex__=function(t){this.vertex=t},t.prototype.send_=function(e){var t=this;if(0==this.vertex.refCount())throw new Error("send() was invoked before listeners were registered");0==this.firings.length&&a.currentTransaction.last(function(){t.firings=[]}),this.firings.push(e);for(var r=this.listeners.slice(),n=function(t){var n=r[t].h;a.currentTransaction.prioritized(r[t].target,function(){a.currentTransaction.inCallback++;try{n(e),a.currentTransaction.inCallback--}catch(t){throw a.currentTransaction.inCallback--,t}})},i=0;i<r.length;i++)n(i)},t}(B),D=function(n){function t(){var t=n.call(this)||this;if(t.assigned__=!1,t.vertex.name="StreamLoop",null===a.currentTransaction)throw new Error("StreamLoop/CellLoop must be used within an explicit transaction");return t}return R(t,n),t.prototype.loop=function(t){var n=this;if(this.assigned__)throw new Error("StreamLoop looped more than once");this.assigned__=!0,this.vertex.addSource(new l(t.getVertex__(),function(){return t.listen_(n.vertex,function(t){n.send_(t)},!1)}))},t}(P),G=function(e){function t(t){var n=e.call(this)||this;return t||(t=function(t,n){throw new Error("send() called more than once per transaction, which isn't allowed. Did you want to combine the events? Then pass a combining function to your StreamSink constructor.")}),n.coalescer=new q(t,n),n}return R(t,e),t.prototype.send=function(t){var n=this;a.run(function(){if(0<a.currentTransaction.inCallback)throw new Error("You are not allowed to use send() inside a Sodium callback");n.coalescer.send_(t)})},t}(P),W=function(t){function n(){return t.call(this,null,new D)||this}return R(n,t),n.prototype.loop=function(t){var n=this;a.run(function(){n.getStream__().loop(t.getStream__()),n.lazyInitValue=t.sampleLazy()})},n.prototype.sampleNoTrans__=function(){if(!this.getStream__().assigned__)throw new Error("CellLoop sampled before it was looped");return t.prototype.sampleNoTrans__.call(this)},n}(H),Y=function(e){function t(t,n){return e.call(this,t,new G(n))||this}return R(t,e),t.prototype.send=function(t){this.getStream__().send(t)},t}(j),Z=function(t,n){this.a=t,this.b=n},F=function(){},J=0,K=function(t,n){this.t=t,this.sAlarm=n,this.seq=++J},X=function(){function t(n){var i=this;this.eventQueue=new e.BSTree(function(t,n){return t.t<n.t?-1:t.t>n.t?1:t.seq<n.seq?-1:t.seq>n.seq?1:0}),a.run(function(){i.impl=n,i.tMinimum=0;var r=new Y(n.now());i.time=r,i.time.listen(function(t){}),a.onStart(function(){for(var e=i.tMinimum=Math.max(i.tMinimum,n.now()),t=function(){var t=null;if(!i.eventQueue.isEmpty()){var n=i.eventQueue.minimum();n.t<=e&&(t=n)}if(null==t)return"break";r.send(t.t),a.run(function(){return t.sAlarm.send_(t.t)})};;){if("break"===t())break}r.send(e)})})}return t.prototype.at=function(n){var t=this,e=null,r=null,i=!1,o=null,u=!1,s=new P(null),c=function(){null!==r&&(r(),t.eventQueue.remove(e)),e=r=null,i&&(u||(u=!0,o=n.sampleNoTrans__()),null!==o&&(e=new K(o,s),t.eventQueue.add(e),r=t.impl.setTimer(o,function(){t.tMinimum=Math.max(t.tMinimum,o),a.run(function(){})})))};return s.setVertex__(new f("at",0,[new l(n.getVertex__(),function(){u=!(i=!0),a.currentTransaction.prioritized(s.getVertex__(),c);var t=n.getStream__().listen_(s.getVertex__(),function(t){o=t,u=!0,c()},!1);return function(){i=!1,c(),t()}})])),s},t}(),$=function(t){function n(){return t.call(this,new tt)||this}return R(n,t),n}(X),tt=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return R(n,t),n.prototype.setTimer=function(t,n){var e=setTimeout(n,Math.max(1e3*(t-this.now()),0));return function(){clearTimeout(e)}},n.prototype.now=function(){return.001*Date.now()},n}(F),nt=function(t){function n(){return t.call(this,new et)||this}return R(n,t),n}(X),et=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return R(n,t),n.prototype.setTimer=function(t,n){var e=setTimeout(n,Math.max(t-this.now(),0));return function(){clearTimeout(e)}},n.prototype.now=function(){return Date.now()},n}(F),rt=function(){function t(){}return t.fromAsync=function(e){return function(t){var n=new P(null);return n.setVertex__(new f("map",0,[new l(t.getVertex__(),function(){return t.listen_(n.getVertex__(),function(t){e(t,function(t){a.run(function(){n.send_(t)})})},!1)})])),n}},t}();t.lambda1=function(t,n){return new p(t,n)},t.lambda2=function(t,n){return new v(t,n)},t.lambda3=function(t,n){return new g(t,n)},t.lambda4=function(t,n){return new x(t,n)},t.lambda5=function(t,n){return new k(t,n)},t.lambda6=function(t,n){return new C(t,n)},t.Stream=B,t.StreamLoop=D,t.StreamSink=G,t.Cell=j,t.CellLoop=W,t.CellSink=Y,t.Transaction=a,t.Tuple2=Z,t.Unit=U,t.Operational=E,t.getTotalRegistrations=function(){return i},t.Vertex=f,t.TimerSystemImpl=F,t.TimerSystem=X,t.SecondsTimerSystem=$,t.MillisecondsTimerSystem=nt,t.IOAction=rt,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=sodium.umd.min.js.map
